# one-python-craftsman

> https://github.com/piglei/one-python-craftsman

## Python å·¥åŒ ï¼šå–„ç”¨å˜é‡æ¥æ”¹å–„ä»£ç è´¨é‡

### å˜é‡åæœ€å¥½è®©äººèƒ½çŒœå‡ºç±»å‹

```txt
is_superuserï¼šã€æ˜¯å¦è¶…çº§ç”¨æˆ·ã€ï¼Œåªä¼šæœ‰ä¸¤ç§å€¼ï¼šæ˜¯/ä¸æ˜¯
has_errorï¼šã€æœ‰æ²¡æœ‰é”™è¯¯ã€ï¼Œåªä¼šæœ‰ä¸¤ç§å€¼ï¼šæœ‰/æ²¡æœ‰
allow_vipï¼šã€æ˜¯å¦å…è®¸ VIPã€ï¼Œåªä¼šæœ‰ä¸¤ç§å€¼ï¼šå…è®¸/ä¸å…è®¸
use_msgpackï¼šã€æ˜¯å¦ä½¿ç”¨ msgpackã€ï¼Œåªä¼šæœ‰ä¸¤ç§å€¼ï¼šä½¿ç”¨/ä¸ä½¿ç”¨
debugï¼šã€æ˜¯å¦å¼€å¯è°ƒè¯•æ¨¡å¼ã€ï¼Œè¢«å½“åš bool ä¸»è¦æ˜¯å› ä¸ºçº¦å®šä¿—æˆ
```

## Python å·¥åŒ ï¼šç¼–å†™æ¡ä»¶åˆ†æ”¯ä»£ç çš„æŠ€å·§

### å¾·æ‘©æ ¹å®šå¾‹

not A or not B ç­‰ä»·äº not (A and B)

### è‡ªå®šä¹‰å¯¹è±¡çš„â€œå¸ƒå°”çœŸå‡â€

æ¯”å¦‚ï¼ŒPython çš„æ‰€æœ‰å¯¹è±¡éƒ½æœ‰è‡ªå·±çš„â€œå¸ƒå°”çœŸå‡â€ï¼š

å¸ƒå°”å€¼ä¸ºå‡çš„å¯¹è±¡ï¼šNone, 0, False, [], (), {}, set(), frozenset(), ... ...
å¸ƒå°”å€¼ä¸ºçœŸçš„å¯¹è±¡ï¼šé 0 çš„æ•°å€¼ã€Trueï¼Œéç©ºçš„åºåˆ—ã€å…ƒç»„ï¼Œæ™®é€šçš„ç”¨æˆ·ç±»å®ä¾‹ï¼Œ... ...


```python
>>> bool(object())
True
```

é‡ç‚¹æ¥äº†ï¼Œè™½ç„¶æ‰€æœ‰ç”¨æˆ·ç±»å®ä¾‹çš„å¸ƒå°”å€¼éƒ½æ˜¯çœŸã€‚ä½†æ˜¯ Python æä¾›äº†æ”¹å˜è¿™ä¸ªè¡Œä¸ºçš„åŠæ³•ï¼šè‡ªå®šä¹‰ç±»çš„ __bool__ é­”æ³•æ–¹æ³• ï¼ˆåœ¨ Python 2.X ç‰ˆæœ¬ä¸­ä¸º __nonzero__ï¼‰ã€‚å½“ç±»å®šä¹‰äº† __bool__ æ–¹æ³•åï¼Œå®ƒçš„è¿”å›å€¼å°†ä¼šè¢«å½“ä½œç±»å®ä¾‹çš„å¸ƒå°”å€¼ã€‚

å¦å¤–ï¼Œ__bool__ ä¸æ˜¯å½±å“å®ä¾‹å¸ƒå°”çœŸå‡çš„å”¯ä¸€æ–¹æ³•ã€‚å¦‚æœç±»æ²¡æœ‰å®šä¹‰ __bool__ æ–¹æ³•ï¼ŒPython è¿˜ä¼šå°è¯•è°ƒç”¨ __len__ æ–¹æ³•*ï¼ˆä¹Ÿå°±æ˜¯å¯¹ä»»ä½•åºåˆ—å¯¹è±¡è°ƒç”¨ len å‡½æ•°ï¼‰*ï¼Œé€šè¿‡ç»“æœæ˜¯å¦ä¸º 0 åˆ¤æ–­å®ä¾‹çœŸå‡ã€‚

### åœ¨æ¡ä»¶åˆ¤æ–­ä¸­ä½¿ç”¨ all() / any()

### ä¸ None å€¼çš„æ¯”è¾ƒ

åœ¨ Python ä¸­ï¼Œæœ‰ä¸¤ç§æ¯”è¾ƒå˜é‡çš„æ–¹æ³•ï¼š== å’Œ isï¼ŒäºŒè€…åœ¨å«ä¹‰ä¸Šæœ‰ç€æ ¹æœ¬çš„åŒºåˆ«ï¼š

==ï¼šè¡¨ç¤ºäºŒè€…æ‰€æŒ‡å‘çš„çš„å€¼æ˜¯å¦ä¸€è‡´
isï¼šè¡¨ç¤ºäºŒè€…æ˜¯å¦æŒ‡å‘å†…å­˜ä¸­çš„åŒä¸€ä»½å†…å®¹ï¼Œä¹Ÿå°±æ˜¯ id(x) æ˜¯å¦ç­‰äº id(y)

## Python å·¥åŒ ï¼šä½¿ç”¨æ•°å­—ä¸å­—ç¬¦ä¸²çš„æŠ€å·§

### dis æ¨¡å—

```python
def f1(delta_seconds):
    if delta_seconds < 11 * 24 * 3600:
        return

import dis
dis.dis(f1)

# dis æ‰§è¡Œç»“æœ
  5           0 LOAD_FAST                0 (delta_seconds)
              2 LOAD_CONST               1 (950400)
              4 COMPARE_OP               0 (<)
              6 POP_JUMP_IF_FALSE       12

  6           8 LOAD_CONST               0 (None)
             10 RETURN_VALUE
        >>   12 LOAD_CONST               0 (None)
             14 RETURN_VALUE
```

### åˆ«å¿˜äº†é‚£äº› â€œrâ€ å¼€å¤´çš„å†…å»ºå­—ç¬¦ä¸²å‡½æ•°

### ä½¿ç”¨â€œæ— ç©·å¤§â€ float("inf")

## Python å·¥åŒ ï¼šå®¹å™¨çš„é—¨é“

### åº•å±‚çœ‹å®¹å™¨

åœ¨ Python 2 ä¸­ï¼Œå¦‚æœä½ è°ƒç”¨ range(100000000)ï¼Œéœ€è¦ç­‰å¾…å¥½å‡ ç§’æ‰èƒ½æ‹¿åˆ°ç»“æœï¼Œå› ä¸ºå®ƒéœ€è¦è¿”å›ä¸€ä¸ªå·¨å¤§çš„åˆ—è¡¨ï¼ŒèŠ±è´¹äº†éå¸¸å¤šçš„æ—¶é—´åœ¨å†…å­˜åˆ†é…ä¸è®¡ç®—ä¸Šã€‚ä½†åœ¨ Python 3 ä¸­ï¼ŒåŒæ ·çš„è°ƒç”¨é©¬ä¸Šå°±èƒ½æ‹¿åˆ°ç»“æœã€‚å› ä¸ºå‡½æ•°è¿”å›çš„ä¸å†æ˜¯åˆ—è¡¨ï¼Œè€Œæ˜¯ä¸€ä¸ªç±»å‹ä¸º range çš„æ‡’æƒ°å¯¹è±¡ï¼Œåªæœ‰åœ¨ä½ è¿­ä»£å®ƒã€æˆ–æ˜¯å¯¹å®ƒè¿›è¡Œåˆ‡ç‰‡æ—¶ï¼Œå®ƒæ‰ä¼šè¿”å›çœŸæ­£çš„æ•°å­—ç»™ä½ ã€‚

æˆ‘ä»¬çš„å‡½æ•°åŒæ ·ä¹Ÿéœ€è¦å˜æ‡’ï¼Œè¿™åŒ…æ‹¬ï¼š

æ›´å¤šçš„ä½¿ç”¨ yield å…³é”®å­—ï¼Œè¿”å›ç”Ÿæˆå™¨å¯¹è±¡
å°½é‡ä½¿ç”¨ç”Ÿæˆå™¨è¡¨è¾¾å¼æ›¿ä»£åˆ—è¡¨æ¨å¯¼è¡¨è¾¾å¼
    1. ç”Ÿæˆå™¨è¡¨è¾¾å¼ï¼š(i for i in range(100)) ğŸ‘
    2. åˆ—è¡¨æ¨å¯¼è¡¨è¾¾å¼ï¼š[i for i in range(100)]

å°½é‡ä½¿ç”¨æ¨¡å—æä¾›çš„æ‡’æƒ°å¯¹è±¡ï¼š
    - ä½¿ç”¨ re.finditer æ›¿ä»£ re.findall
    - ç›´æ¥ä½¿ç”¨å¯è¿­ä»£çš„æ–‡ä»¶å¯¹è±¡ï¼š for line in fpï¼Œè€Œä¸æ˜¯ for line in fp.readlines()

### ä½¿ç”¨å…ƒç»„æ”¹å–„åˆ†æ”¯ä»£ç 

```python
import bisect


# BREAKPOINTS å¿…é¡»æ˜¯å·²ç»æ’å¥½åºçš„ï¼Œä¸ç„¶æ— æ³•è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾
BREAKPOINTS = (1, 60, 3600, 3600 * 24)
TMPLS = (
    # unit, template
    (1, "less than 1 second ago"),
    (1, "{units} seconds ago"),
    (60, "{units} minutes ago"),
    (3600, "{units} hours ago"),
    (3600 * 24, "{units} days ago"),
)


def from_now(ts):
    """æ¥æ”¶ä¸€ä¸ªè¿‡å»çš„æ—¶é—´æˆ³ï¼Œè¿”å›è·ç¦»å½“å‰æ—¶é—´çš„ç›¸å¯¹æ—¶é—´æ–‡å­—æè¿°
    """
    seconds_delta = int(time.time() - ts)
    unit, tmpl = TMPLS[bisect.bisect(BREAKPOINTS, seconds_delta)]
    return tmpl.format(units=seconds_delta // unit)
```

### åœ¨æ›´å¤šåœ°æ–¹ä½¿ç”¨åŠ¨æ€è§£åŒ…

```user = {**{"name": "piglei"}, **{"movies": ["Fight Club"]}}```

## Python å·¥åŒ ï¼šè®©å‡½æ•°è¿”å›ç»“æœçš„æŠ€å·§

### ç¼–ç¨‹å»ºè®®

1. å•ä¸ªå‡½æ•°ä¸è¦è¿”å›å¤šç§ç±»å‹
2. partial æ„é€ æ–°å‡½æ•°

partial(func, *args, **kwargs) åŸºäºä¼ å…¥çš„å‡½æ•°ä¸å¯å˜ï¼ˆä½ç½®/å…³é”®å­—ï¼‰å‚æ•°æ¥æ„é€ ä¸€ä¸ªæ–°å‡½æ•°ã€‚æ‰€æœ‰å¯¹æ–°å‡½æ•°çš„è°ƒç”¨ï¼Œéƒ½ä¼šåœ¨åˆå¹¶äº†å½“å‰è°ƒç”¨å‚æ•°ä¸æ„é€ å‚æ•°åï¼Œä»£ç†ç»™åŸå§‹å‡½æ•°å¤„ç†ã€‚

3. å¼‚å¸¸

```python
class CreateItemError(Exception):
    """åˆ›å»º Item å¤±è´¥æ—¶æŠ›å‡ºçš„å¼‚å¸¸"""
```

## Python å·¥åŒ ï¼š å¼‚å¸¸å¤„ç†çš„ä¸‰ä¸ªå¥½ä¹ æƒ¯

## Python å·¥åŒ ï¼šç¼–å†™åœ°é“å¾ªç¯çš„ä¸¤ä¸ªå»ºè®®

### ä»€ä¹ˆæ˜¯â€œåœ°é“â€çš„å¾ªç¯ï¼Ÿ

```python
for i, name in enumerate(names):
    print(i, name)
```

### ä½¿ç”¨ islice å®ç°å¾ªç¯å†…éš”è¡Œå¤„ç†

> itertools.islice(iterable, start, stop[, step])

åˆ›å»ºä¸€ä¸ªè¿­ä»£å™¨ï¼Œè¿”å›ä» iterable é‡Œé€‰ä¸­çš„å…ƒç´ ã€‚å¦‚æœ start ä¸æ˜¯0ï¼Œè·³è¿‡ iterable ä¸­çš„å…ƒç´ ï¼Œç›´åˆ°åˆ°è¾¾ start è¿™ä¸ªä½ç½®ã€‚ä¹‹åè¿­ä»£å™¨è¿ç»­è¿”å›å…ƒç´ ï¼Œé™¤é step è®¾ç½®çš„å€¼å¾ˆé«˜å¯¼è‡´è¢«è·³è¿‡ã€‚å¦‚æœ stop ä¸º Noneï¼Œè¿­ä»£å™¨è€—å…‰ä¸ºæ­¢ï¼›å¦åˆ™ï¼Œåœ¨æŒ‡å®šçš„ä½ç½®åœæ­¢ã€‚ä¸æ™®é€šçš„åˆ‡ç‰‡ä¸åŒï¼Œislice() ä¸æ”¯æŒå°† start ï¼Œ stop ï¼Œæˆ– step è®¾ä¸ºè´Ÿå€¼ã€‚å¯ç”¨æ¥ä»å†…éƒ¨æ•°æ®ç»“æ„è¢«å‹å¹³çš„æ•°æ®ä¸­æå–ç›¸å…³å­—æ®µï¼ˆä¾‹å¦‚ä¸€ä¸ªå¤šè¡ŒæŠ¥å‘Šï¼Œå®ƒçš„åç§°å­—æ®µå‡ºç°åœ¨æ¯ä¸‰è¡Œä¸Šï¼‰


### ä½¿ç”¨ takewhile æ›¿ä»£ break è¯­å¥

```diff
- for user in users:
-     # å½“ç¬¬ä¸€ä¸ªä¸åˆæ ¼çš„ç”¨æˆ·å‡ºç°åï¼Œä¸å†è¿›è¡Œåé¢çš„å¤„ç†
-     if not is_qualified(user):
-         break
- 
-     # è¿›è¡Œå¤„ç† ... ...

+ from itertools import takewhile
+ 
+ for user in takewhile(is_qualified, users):
+     # è¿›è¡Œå¤„ç† ... ...
```

ä½¿ç”¨ chain å‡½æ•°æ‰å¹³åŒ–åŒå±‚åµŒå¥—å¾ªç¯
ä½¿ç”¨ zip_longest å‡½æ•°ä¸€æ¬¡åŒæ—¶å¾ªç¯å¤šä¸ªå¯¹è±¡

## Python å·¥åŒ ï¼šä½¿ç”¨è£…é¥°å™¨çš„æŠ€å·§

ä½¿ç”¨ callable å¯ä»¥æ£€æµ‹æŸä¸ªå¯¹è±¡æ˜¯å¦â€œå¯è¢«è°ƒç”¨â€

### å°è¯•ç”¨ç±»æ¥å®ç°è£…é¥°å™¨

```python
import time
import functools


class DelayFunc:
    def __init__(self,  duration, func):
        self.duration = duration
        self.func = func

    def __call__(self, *args, **kwargs):
        print(f'Wait for {self.duration} seconds...')
        time.sleep(self.duration)
        return self.func(*args, **kwargs)

    def eager_call(self, *args, **kwargs):
        print('Call without delay')
        return self.func(*args, **kwargs)


def delay(duration):
    """è£…é¥°å™¨ï¼šæ¨è¿ŸæŸä¸ªå‡½æ•°çš„æ‰§è¡Œã€‚åŒæ—¶æä¾› .eager_call æ–¹æ³•ç«‹å³æ‰§è¡Œ
    """
    # æ­¤å¤„ä¸ºäº†é¿å…å®šä¹‰é¢å¤–å‡½æ•°ï¼Œç›´æ¥ä½¿ç”¨ functools.partial å¸®åŠ©æ„é€ 
    # DelayFunc å®ä¾‹
    return functools.partial(DelayFunc, duration)


@delay(duration=2)
def add(a, b):
    return a + b


# è¿™æ¬¡è°ƒç”¨å°†ä¼šå»¶è¿Ÿ 2 ç§’
add(1, 2)
# è¿™æ¬¡è°ƒç”¨å°†ä¼šç«‹å³æ‰§è¡Œ
add.eager_call(1, 2)
```





